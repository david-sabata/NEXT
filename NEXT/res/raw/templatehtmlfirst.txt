<html>
    <head>
        <title>Self-editing page</title>
        
        <!-- Basic style of the page -->
        <style>
            .invisible {
                display:none;
            }

            /**
            Whole body    
            **/
            * {
                margin:0;
                padding:0;
            }
            body {

            }

            /* Contain all other boxes*/
            #wholePage {
                height:100%;
            }

                #topBox {
                    height:50px;
                    background:grey;
                }
                    #nextLogo {
                        float:left;
                        height:50px;
                        margin-left:10px;
                    }

                    #nameOfProject {
                        width:100%;
                    }
                    #projectNameTop {
                        color:#33b6ea;
                        text-align:center;
                        line-height:50px;
                        font-weight:bold;
                        font-size:25pt;
                        text-shadow:5px 5px 15px  black;
                    }
                #mainBox {
                    height:100%;
                }

                    #sideBar {
                        width:15%;
                        height:100%;
                        float:left;
                        background:#2c2c2c;
                        box-shadow: 3px 3px 5px black;
                      
                    }
                        .sideBarUl {
                            margin-bottom:30px;
                        }

                        .sideBarTitleUl {
                            text-align:center;
                            line-height:30px;
                            border-top:2px solid #33b6ea;
                            color : #33b6ea;
                            font-weight:bold;
                            font-size:14pt;
                        }
                        .sideBarTitleUl span{
                            margin:0px;
                        }


                        .sideBarImage {
                            float:left;
                            height:40px;
                        }
                        .sideBaritem {
                            font-size:13pt;
                            color:white;
                            height: 40px;
                            line-height:40px;
                            list-style-type:none;
                        }

                        .sideBaritem:hover {
                            background:#8FB5D0;
                            color:white;
                        }

                        .sideBarContextItem {
                            margin-left:40px;
                        }
                    
                    /**
                        Contain content of tasks    
                    */
                    #taskListDiv {
                        height:100%;
                        float:left;           
                        width:85%;
                        
                                 
                    }

                        #taskList {
                            margin:auto;    
                            border-collapse:collapse;
                            margin-left:3px;
                            width:100%;
                          
                        }

                            .tableCell {
                                padding:3px;
                            }

                            .statusCell {
                                text-align:center;
                            }

                            .tableHeader {
                                  padding:3px;
                            }
        </style>


        <!-- Javascript worker -->
        <script type="text/javascript">
            /**
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             * ///////////////////////////////// NEW OBJECT DEFINITION///////////////////////////////////////////
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             */
            function TopPanelCreator() {

                this.init = init;

                function init(projectName, images) {
                    var logo = images.getImage('nextLogo');
                    logo.setAttribute("id", "nextLogo");
                    document.getElementById("logoImgPlace").appendChild(logo);

                    var el = document.getElementById("nameOfProject");
                    el.setAttribute("id", "projectNameTop");
                    el.innerHTML = projectName;
                }
            }
            /**
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             * ///////////////////////////////// NEW OBJECT DEFINITION///////////////////////////////////////////
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             */
            function MenuCreator() {
                var images = null;
                var menu = null;
                var settings = null;
                var lang = 'czech';

                var commonMethods = new CommonWorker();
                // Parse languages texts
                var languagesTexts = eval('(' + commonMethods.getContentOfScriptTag(document.getElementById('languages')) + ')');

                // Public handlers to private method
                this.init = init;
                this.setMenuSettings = setMenuSettings;
                this.regenerate = regenerate;
                this.setLanguage = setLanguage;

                /**
                * Initialize menu element and images
                */
                function init(el, pImages) {
                    images = pImages;
                    menu = el;
                }

                /**
                * This is important, becaouse object settings tell us, how will menu work
                */
                function setMenuSettings(pSettings) {
                    settings = pSettings;
                }

                function setLanguage(pLang) {
                    lang = pLang;
                }

                function createLi(img, liData) {
                    var li = document.createElement('li');
                    var span = document.createElement('span');

                    if (img != null) {
                        // Prepare text of item                        
                        span.innerHTML = languagesTexts[lang][liData];

                        var image = images.getImage(img);
                        image.setAttribute("class", "sideBarImage");

                        // Add image to item
                        li.appendChild(image);
                    } else {
                        span.innerHTML = liData; // Contexts are unique -> they cant be translated
                        span.setAttribute("class", "sideBarContextItem");                    

                        // Add event listener to context
                        li.addEventListener("click", function () {
                            editor.setContexts([liData]);
                            editor.cleanTaskList();
                            editor.generateTaskList();
                        });
                    }
                

                    li.appendChild(span);
                    li.setAttribute("class", "sideBarItem");
                    return li;
                }

                function createUl(s, ulData) {
                    var ul = document.createElement('ul');

                    ul.setAttribute("class", "sideBarUl");
                    
                    // Create description of UL block
                    var titleUl = createLi(null, languagesTexts[lang][s]);
                    titleUl.setAttribute("class", "sideBarTitleUl");
                    ul.appendChild(titleUl);

                    for (item in ulData) {

                        // Fixed part of menu
                        if (s == 'time') {
                            var li = createLi(ulData[item], item);
                        } else {
                            // variable part of menu
                            var li = createLi(null, ulData[item]);
                        }
                        ul.appendChild(li);
                    }
                    
                    return ul;
                }

                /**
                * Regenerate Menu
                */
                function regenerate() {
                    for (s in settings) {
                        var ul = createUl(s, settings[s]);
                        menu.appendChild(ul);
                    }
                }
            }

            /**
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             * ///////////////////////////////// NEW OBJECT DEFINITION///////////////////////////////////////////
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             */
            /**
            * This object will create all iamges that are defined in script tag with bass64 data
            */
            function ImageCreator() {
                var images = null;
                var commonMethods = new CommonWorker();
                var data;

                this.init = init;
                this.getImage = getImage;
                function init(ids) {
                   
                    images = new Object();
                    for(id in ids) {
                        var imgTag = document.getElementById(ids[id]);
                        images[ids[id]] = imgTag;
                    }
                };

                /**
                * Return HTML image tag
                * return concrete image
                */
                function getImage(key) {
                    console.log(images[key]);
                    return images[key];

                }
            }
            /**
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             * ///////////////////////////////// NEW OBJECT DEFINITION///////////////////////////////////////////
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             */
            /**
            * This object contatin methods, that needs all other object (like working with DOM and etc.)
            */
            function CommonWorker() {

                // Public handler to private method
                this.getContentOfScriptTag = getContentOfScriptTag;
                this.findAllContexts = findAllContexts;

                /**
                * Load plain text from script tag
                */
                function getContentOfScriptTag(el) {
                    var plainText = "";
                    var node = el.firstChild;
                    while (node) {
                        if (node.nodeType == 3) {
                            plainText += node.textContent;
                        }
                        node = node.nextSibling;
                    }
                    return plainText;
                }

               
                /**
                * Go ghrought data and find all contexts
                */
                function findAllContexts(pData) {
                    var contexts = [];
                    var taskData = pData.data;
                    for (task in taskData) {
                        var taskContexts = (taskData[task]).partContexts;
                        for (c in taskContexts) {
                            if (contexts.indexOf(taskContexts[c]) == -1) {
                                contexts.push(taskContexts[c]);
                            }
                        }
                    }
                    return contexts;
                }
            }

            /**
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             * ///////////////////////////////// NEW OBJECT DEFINITION///////////////////////////////////////////
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             */
            /**
            * Page modules, generator patterns
            */
            function TaskListGenerator() {
                // Constants
                var languageElement = document.getElementById('languages');

                var tasksData = null;
                var table = null;
                var contexts = null;

                var commonMethods = new CommonWorker();

                // Public handlers to private method
                this.createContent = createContent;


                /**
                * Generate content of cell and setting style of the cell
                */
                function createCell(pText, pBgColor, pTextColor, pBorders, pBold, pClass, pBorderColor) {
                    // Create a new TD element
                    var newTD = document.createElement('td');
                    newTD.innerHTML = pText;
                    newTD.setAttribute("style","background:" + pBgColor + ";" + 
                                               "color:" + pTextColor + ";" +
                                               "border-left:" + pBorders[0] + "px " + pBorderColor+ ";" +
                                               "border-right:" + pBorders[1] + "px " + pBorderColor + ";" +
                                               "border-bottom:" + pBorders[2] + "px " + pBorderColor+ ";" +
                                                "border-top:" + pBorders[2] + "px " + pBorderColor+ ";" +
                                               "font-weight:" + pBold);
                    newTD.setAttribute("class", pClass);
                    return newTD;
                }


                /**
                * Generate table header in language you want
                */
                function generateTableHeader(lang) {
                    // Parse languages texts
                    var languagesTexts = eval('(' + commonMethods.getContentOfScriptTag(languageElement) + ')');

                    // Create new row element
                    var newTR = document.createElement('tr');
                    var data = tasksData;
                    if(data) {
                        var task = data[0];
                        for (item in task) {
                            // Create a new TD element
                            var newTD = createCell((languagesTexts[lang])[item], '#2c2c2c', '33b6ea', [1, 1, 1, 1], 'bold', "tableHeader", 'solid black'); // left, right, bottom, top
                            newTR.appendChild(newTD);
                        }                
                    }
                    return newTR;
                }
                /**
                * Generate on row in Task List
                */
                function createRow(task) {
                    // Create new row element
                    var newTR = document.createElement('tr');
                   

                    // Generate cells of the new row
                    for (item in task) {
                        // Create a new TD element
                        var newTD;
                        var borderColor = "solid grey";
                        var classCells = "tableCell";
                        switch (item) {
                            case 'title':
                                                   // text,    bgColor, textColor, borderOn, fontWeight
                                newTD = createCell(task[item], 'white', 'black', [1, 1, 1, 1], 'normal', classCells, borderColor); // left, right, bottom, top
                                break;

                            case 'description':
                                newTD = createCell(task[item], 'white', 'black', [1, 1, 1, 1], 'normal',classCells, borderColor);
                                break;

                            case 'date':
                                newTD = createCell(task[item], 'white', 'black', [1, 1, 1, 1], 'normal', classCells, borderColor);
                                break;

                            case 'partProject':
                                newTD = createCell(task[item], 'white', 'black', [1, 1, 1, 1], 'normal', classCells, borderColor);
                                break;

                            case 'partContexts':
                                newTD = createCell(task[item], 'white', 'black', [1, 1, 1, 1], 'normal', classCells, borderColor);
                                break;

                            case 'important':
                                var bgColor;
                                var value = task[item];
                                if(value == 1) {
                                    bgColor = '#2f9b3e';
                                } else if(value == 2) {
                                    bgColor = '#ceef4a';
                                } else {
                                    bgColor = '#ff3333';
                                }

                                newTD = createCell("", bgColor, 'black', [1, 1, 1, 1], 'normal', classCells, borderColor);
                                break;
                            case 'status':
                                var value = task[item];
                                var el;
                                /**
                                * I know, that it is not ideal, but it is quick and easy solution
                                */
                                if (value == true) {
                                    el = '<input type="checkbox" checked="checked" />';
                                } else {
                                    el = '<input type="checkbox"  />';
                                }
                                newTD = createCell(el, 'white', 'black', [1, 1, 1, 1], 'normal', "statusCell", borderColor);
                                break;

                            default:
                                console.log("Unknown properties of object");
                                break;
                        }

                        newTR.appendChild(newTD);
                    }

                    return newTR;
                }

                /**
                * Is item in actual context?
                */
                function isInContext(taskContext) {
                    for(c in taskContext) {
                        for (gc in contexts) {
                            if(taskContext[c] == contexts[gc]) {
                                return true;
                            }
                        }
                    }
                    return false;
                }

                /**
                 * Genre content of the table
                 */
                function generateTable() {
                   table.appendChild(generateTableHeader('czech'));

                    // Create new divs and add them to parent div
                   for (task in tasksData) {
                       if(isInContext(tasksData[task].partContexts)) {
                           // Generate new element
                           var newRow = createRow(tasksData[task]);
                           table.appendChild(newRow);
                       }
                    }
                }

                /**
                * Initialize data
                */
                function createContent(pTable, pData, pContexts) {
                    tasksData = pData;
                    table = pTable;
                    contexts = pContexts;

                    // Table content generation
                    generateTable();
                }

            }
            /**
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             * ///////////////////////////////// NEW OBJECT DEFINITION///////////////////////////////////////////
             * //////////////////////////////////////////////////////////////////////////////////////////////////
             */

            /**
            * Editor Worker
            * it is main worker, that control generating whole page
            */
            function EditorWorker() {
                // constants
                var taskListId = "taskList";
                var contexts = null;
                // variables
                var tasksData = null;

                // public handlers to private methods
                this.init = init;
                this.setContexts = setContexts;
                this.cleanTaskList = cleanTaskList;
                this.generateTaskList = generateTaskList;

                var generatorTaskList = new TaskListGenerator();
                var commonMethods = new CommonWorker();


                /**
                 * We have to initialize page on start
                 */
                function init(pTasksData) {
                    // Dynamically add tasks from tasksData to page
                    tasksData = pTasksData;
                    generateTaskList();
                }

                /**
                * Set Contexts, that we want to see
                */
                function setContexts(pContexts) {
                    contexts = pContexts;
                }

                /**
                * Delete TaskList cotnent on page
                */
                function cleanTaskList() {
                    document.getElementById(taskListId).innerHTML = "";
                }

                /**
                * Fill Task with data
                */
                function generateTaskList() {
                    console.log(contexts);
                    generatorTaskList.createContent(document.getElementById(taskListId), tasksData.data, contexts);
                }

            }
        </script>

        <!-- Languages data stored -->
        <script id="languages" type="x-next/xlanguages">
            {
              czech: {
                        title: "Název",
                        description: "Popis",
                        date: "Datum",
                        partProject : "Projekt",
                        partContexts : "Kontexty",
                        important: "Dùležitost",
                        status: "Hotovo",
                        next: "Další",
                        today: "Dnes",
                        inplan: "V plánu",
                        sometimes: "Nìkdy",
                        blocked: "Blokované",
                        time: "Podle èasu",
                        context: "Kontexty"
                     } ,
             english: {
                        title: "Title",
                        description: "Description",
                        date: "Date",
                        partProject : "Project",
                        partContexts :"Contexts",
                        important: "Important",
                        status: "Done",
                        next: "Next",
                        today: "Today",
                        inplan: "In plan",
                        sometimes: "Sometimes",
                        blocked: "Blocked",
                        time: "Time",
                        context: "Contexts"
             }
                
            }
        </script>

        <!-- Here we will store our data for tasks -->
        <script id="data" type="x-next/x-json">
          var data = 
          //begin_of_data 